@using System.Web.Optimization
@using SimpleBookKeeping.Extensions
@model SimpleBookKeeping.Models.CostModel
@{
    ViewBag.Title = "Расход";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Styles.Render("~/cost.css")


<form id="cost-save" action="/Cost/Save" method="POST" data-ajax="false">
    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="PlanId" value="@Model.PlanId" />

    <div class="cost-page margin10">
        <input type="text" name="Name" placeholder="Название расходов"
               value="@(Model == null ? string.Empty : Model.Name)" />
        @Html.ValidationMessageFor(model => model.Name)
        @Html.ValidationMessageFor(model => model.PlanId)
        

        <table>
            <tr><th> День </th> <th> Дата </th><th> Сумма </th></tr>
            @{
                int list = 0;
                foreach (var costDetailModel in Model?.CostDetails.OrderBy(x => x.Date))
                {
                    <tr class=" @(costDetailModel.Date.DayOfWeek == DayOfWeek.Sunday ||
                                  costDetailModel.Date.DayOfWeek == DayOfWeek.Saturday ? "holiday" : string.Empty) ">
                        
                        <td> @costDetailModel.Date.DayOfWeek.ToShortRuString() </td>
                        <td> @costDetailModel.Date.ToString("dd-MM-yyyy") </td>
                        <td>
                            <input type="hidden" name="CostDetails[@list].Date" value="@costDetailModel.Date.ToString("dd-MM-yyyy")"/>
                            <input type="text" name="CostDetails[@list].Value" value="@(costDetailModel.Value == 0 ?
                                                                                            string.Empty : costDetailModel.Value.ToString())"/>
                        </td>
                    </tr>

                    list++;
                }
            }
        </table>

        <input type="submit" data-icon="check" value="Сохранить"/>

        @if (Model.Id != Guid.Empty)
        {
            <a data-role="button" data-icon="delete" data-theme="b" onclick="Remove()">Удалить</a>
        }

    </div>
    
</form>

<script type="text/javascript">
    backUrl = "/Cost/Index?planId=@Model.PlanId";

    function Remove() {
        if (confirm("Вы действительно хотите удалить расход: @Model.Name")) {
            showLoading();
            $.get('/Cost/Remove?id=@Model.Id', function (data) {
                if (data.length > 5) {
                    alert("Ошибка удаления расхода");
                } else {
                    redirect("/Cost/Index?planId=@Model.PlanId");
                }
            });
        }
    }

    $(document).ready(function () {
        saveFunc = function() {
            $("#cost-save").submit();
        }
        showSaveButton();
    });

</script>
