@using System.Web.Optimization
@using SimpleBookKeeping.Models
@model IList<CostSpendDetailModel>
@{
    IList<CostSpendDetailModel> costSpends = Model;
    ViewBag.Title = "Траты: " + costSpends.FirstOrDefault()?.CostName;
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool fisrt = true;
    var currentDate = DateTime.Now.Date;
}

@*@Styles.Render("~/Content/site/spend")*@
<link rel="stylesheet" type="text/css" href="/Content/site/spend.css">

<div class="spend-row" data-role="collapsible-set">

    @foreach (CostSpendDetailModel costSpendDetailModel in costSpends.Where(x => x.Date.Date <= currentDate.Date.Date).OrderByDescending(x => x.Date))
    {
        string formId = "update-spend-" + costSpendDetailModel.CostId.ToString().Replace("-", "");
        int spendIterator = 0;
        bool editable = costSpendDetailModel.Date.Date > currentDate.Date.AddDays(-2).Date && costSpendDetailModel.Date.Date <= currentDate.Date.Date;

        <form id="@formId" action="/Spend/Update" method="POST" data-ajax="false">

            <div class='@(editable ? "editable" : string.Empty) spend-row-detail'
                 data-collapsed-icon="carat-r" data-expanded-icon="carat-d" data-role='collapsible' @(fisrt ? Html.Raw("data-collapsed='false'") : Html.Raw(""))>

                <h3>
                    @costSpendDetailModel.Date.ToString("dd.MM.yyyy") <span class="ui-li-count ui-body-inherit">@costSpendDetailModel.Spends.Sum(x => x.Value)</span>
                </h3>

                <ul id="@costSpendDetailModel.DetailId" class="@(editable ? "editable" : string.Empty) custom-list" data-role="listview" data-inset="true">
                    @foreach (var spend in costSpendDetailModel.Spends)
                    {
                        if (spend.UserId == ViewBag.UserId)
                        {
                            <li>

                                @(editable ?
                                  Html.Raw($"<input name='addSpendModels[{spendIterator}].Comment' class='comment' type='text' value='{spend.Comment}'/>") :
                                  Html.Raw(spend.Comment ?? " "))

                                <input type="hidden" name="addSpendModels[@spendIterator].CostId" value="@costSpends.First().CostId" />
                                <input type="hidden" name="addSpendModels[@spendIterator].Id" value="@spend.Id" />
                                <input type="hidden" name="addSpendModels[@spendIterator].CostDetailId" value="@costSpendDetailModel.DetailId" />

                                @(editable ?
                                  Html.Raw($"<input name='addSpendModels[{spendIterator}].Value' class='sum' type='text' value='{spend.Value}'/>") :
                                  Html.Raw($"<span class='ui-li-count' ui-body-inherit'>{spend.Value}</span> "))
                            </li>

                            spendIterator++;
                        }
                        else
                        {
                            <li>
                                @(editable ?
                                  Html.Raw($"<input class='input-readonly comment' type='text' value='{spend.Comment}'/>") :
                                  Html.Raw(spend.Comment ?? " "))

                                @(editable ?
                                  Html.Raw($"<input class='input-readonly sum' type='text' value='{spend.Value}'/>") :
                                  Html.Raw($"<span class='ui-li-count' ui-body-inherit'>{spend.Value}</span> "))
                            </li>
                        }

                    }

                    <li id="add-button" data-icon="plus" class="add-spend">
                        <div class="spend-sum">
                            Сумма: @costSpendDetailModel.Spends.Sum(x => x.Value)
                        </div>
                        @if (editable)
                        {
                            <div onclick="Add('@costSpendDetailModel.DetailId')" class="spend-add ui-btn ui-input-btn ui-shadow"> Добавить </div>
                        }
                    </li>

                </ul>

                @if (editable && costSpendDetailModel.Spends.Any(x=>x.UserId == ViewBag.UserId))
                {
                    <a data-role="button" class="margin10" data-icon="check" onclick="Update('@formId')">Сохранить</a>
                }

            </div>
        </form>

        fisrt = false;
    }

</div>


<div data-role="popup" id="popupDialog" data-overlay-theme="a" data-theme="a" style="max-width: 400px;"
     class="ui-corner-all ui-popup ui-body-a ui-overlay-shadow">
    <form id="add-spend" action="/Spend/Add" method="POST" data-ajax="false">
        <div data-role="header" data-theme="a" class="ui-corner-top ui-header ui-bar-a" role="banner">
            <h1 class="ui-title" role="heading" aria-level="1">Траты</h1>
        </div>
        <div role="main" class="ui-corner-bottom ui-content">
            <h3 class="ui-title">Добавить траты</h3>

            <input type="hidden" name="CostId" value="@(costSpends.FirstOrDefault()?.CostId)" />
            <input id="detailId" type="hidden" name="CostDetailId" value="" />
            <input class='comment' name="Comment" type='text' value='' placeholder="Коментарий" />
            <input class='sum' name="Value" type='text' value='' placeholder="Сумма" />

            <a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="a"
               class="ui-link ui-btn ui-btn-a ui-btn-inline ui-shadow ui-corner-all" role="button">Отменить</a>
            <a href="#" onclick="Submit()" data-role="button" data-inline="true" data-transition="flow"
               data-theme="b" class="ui-link ui-btn ui-btn-b ui-btn-inline ui-shadow ui-corner-all" role="button">Добавить</a>
        </div>
    </form>
</div>


<script type="text/javascript">
    var selectedCostDetail;
    backUrl = "/Home/Index";

    $(document).ready(function () {
        $('.input-readonly').textinput('disable');
    });

    function Update(id) {
        showLoading();
        setTimeout(function () {
            $("#" + id).submit();
        }, 500);
    }

    function Add(id) {
        $("#detailId").val(id);
        $("#popupDialog").popup();
        $("#popupDialog").popup("open", {
            transition: "pop",
            positionTo: "window"
        });
    }

    function Submit() {
        showLoading();
        $("#popupDialog").fadeOut(300);
        setTimeout(function () {
            $("#add-spend").submit();
        }, 500);
    }

</script>